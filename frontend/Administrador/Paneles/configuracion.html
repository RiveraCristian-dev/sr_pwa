<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Flota - RutaTec</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a3a5f;
            --secondary: #2ecc71;
            --light-bg: #f8f9fa;
            --white: #ffffff;
        }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--light-bg);
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            background: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn-back {
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: var(--primary);
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .btn-primary {
            background: var(--primary);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .vehicles-list {
            margin-top: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: var(--primary);
            color: white;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-disponible {
            background: #d4edda;
            color: #155724;
        }
        
        .status-asignado {
            background: #fff3cd;
            color: #856404;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            display: none;
            z-index: 1000;
        }
        
        .notification.success {
            background: var(--secondary);
        }
        
        .notification.error {
            background: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1><i class="fas fa-truck"></i> Gesti√≥n de Flota</h1>
                <p>Administra veh√≠culos y asignaciones</p>
            </div>
            <a href="../PanelADM.html" class="btn-back">
                <i class="fas fa-arrow-left"></i> Volver al Panel
            </a>
        </header>
        
        <div class="dashboard">
            <!-- SECCI√ìN 1: Registrar Veh√≠culo -->
            <div class="card">
                <h2><i class="fas fa-plus-circle"></i> Registrar Nuevo Veh√≠culo</h2>
                <form id="formVehiculo">
                    <div class="form-group">
                        <label><i class="fas fa-tag"></i> Modelo *</label>
                        <input type="text" id="modelo" required placeholder="Ej: Toyota Hilux 2023">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-gas-pump"></i> Tipo de Veh√≠culo *</label>
                        <select id="tipo" required>
                            <option value="">Seleccionar</option>
                            <option value="gasolina">Gasolina</option>
                            <option value="electrico">El√©ctrico</option>
                            <option value="hibrido">H√≠brido</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-boxes"></i> Capacidad M√°xima (paquetes) *</label>
                        <input type="number" id="capacidad" min="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-tachometer-alt"></i> Velocidad Promedio (km/h) *</label>
                        <input type="number" id="velocidad" min="1" step="0.1" value="40" required>
                    </div>
                    <!-- Campos espec√≠ficos por tipo (mostrar/ocultar din√°micamente) -->
<div id="camposGasolina" style="display: none;">
    <div class="form-group">
        <label><i class="fas fa-tint"></i> Rendimiento (km/litro) *</label>
        <input type="number" id="rendimientoGasolina" step="0.1" placeholder="Ej: 8.5">
    </div>
    
    <div class="form-group">
        <label><i class="fas fa-dollar-sign"></i> Precio Gasolina ($/litro)</label>
        <input type="number" id="precioGasolina" step="0.01" value="22.50">
    </div>
</div>

<div id="camposElectrico" style="display: none;">
    <div class="form-group">
        <label><i class="fas fa-bolt"></i> Rendimiento (km/kWh) *</label>
        <input type="number" id="rendimientoElectrico" step="0.1" placeholder="Ej: 6.0">
    </div>
    
    <div class="form-group">
        <label><i class="fas fa-dollar-sign"></i> Precio kWh ($)</label>
        <input type="number" id="precioKwh" step="0.01" value="2.50">
    </div>
</div>

<div class="form-group">
    <label><i class="fas fa-clock"></i> Hora de Env√≠o (opcional)</label>
    <input type="time" id="horaEnvio">
</div>
                    
                    <button type="submit" class="btn" id="btnGuardarVehiculo">
                        <i class="fas fa-save"></i> Guardar Veh√≠culo
                    </button>
                </form>
            </div>
            
            <!-- SECCI√ìN 2: Asignar Veh√≠culo -->
            <div class="card">
                <h2><i class="fas fa-user-check"></i> Asignar a Repartidor</h2>
                <form id="formAsignacion">
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Repartidor *</label>
                        <select id="repartidorId" required>
                            <option value="">Cargando repartidores...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-truck"></i> Veh√≠culo Disponible *</label>
                        <select id="vehiculoId" required>
                            <option value="">Cargando veh√≠culos...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-boxes"></i> N√∫mero de Paquetes *</label>
                        <input type="number" id="numeroPaquetes" min="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-map-marked-alt"></i> Ruta/Municipio</label>
                        <input type="text" id="rutaMunicipio" placeholder="Ej: Centro, Guadalajara">
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="btnAsignar">
                        <i class="fas fa-link"></i> Asignar Veh√≠culo
                    </button>
                </form>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                    <h3><i class="fas fa-sync-alt"></i> Liberar Asignaci√≥n</h3>
                    <div class="form-group">
                        <label>Seleccionar asignaci√≥n activa</label>
                        <select id="asignacionActiva">
                            <option value="">Seleccionar</option>
                        </select>
                    </div>
                    <button type="button" id="btnLiberar" class="btn" style="background: #e74c3c;">
                        <i class="fas fa-unlink"></i> Liberar Veh√≠culo
                    </button>
                </div>
            </div>
        </div>
        
        <!-- SECCI√ìN 3: Lista de Veh√≠culos -->
        <div class="card vehicles-list">
            <h2><i class="fas fa-list"></i> Veh√≠culos Registrados</h2>
            <table id="tablaVehiculos">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Modelo</th>
                        <th>Tipo</th>
                        <th>Capacidad</th>
                        <th>Estado</th>
                        <th>Asignado a</th>
                    </tr>
                </thead>
                <tbody id="cuerpoTabla">
                    <tr>
                        <td colspan="6" style="text-align: center;">Cargando...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Notificaci√≥n -->
    <div id="notification" class="notification"></div>

    <script>
        // ===== CONFIGURACI√É"N API =====
const API_URL = 'http://localhost:8000/api';

// ===== FUNCIONES UTILITARIAS =====
function mostrarNotificacion(mensaje, tipo = 'success') {
    const notif = document.getElementById('notification');
    notif.textContent = mensaje;
    notif.className = `notification ${tipo}`;
    notif.style.display = 'block';
    
    setTimeout(() => {
        notif.style.display = 'none';
    }, 3000);
}

// ===== MOSTRAR/OCULTAR CAMPOS SEG√ÉN TIPO DE VEH√ÉCULO =====
document.getElementById('tipo').addEventListener('change', function() {
    const tipo = this.value;
    const camposGasolina = document.getElementById('camposGasolina');
    const camposElectrico = document.getElementById('camposElectrico');
    
    // Ocultar todos primero
    camposGasolina.style.display = 'none';
    camposElectrico.style.display = 'none';
    
    // Limpiar required de todos
    document.getElementById('rendimientoGasolina').required = false;
    document.getElementById('rendimientoElectrico').required = false;
    
    // Mostrar seg√∫n tipo
    if (tipo === 'gasolina') {
        camposGasolina.style.display = 'block';
        document.getElementById('rendimientoGasolina').required = true;
    } 
    else if (tipo === 'electrico') {
        camposElectrico.style.display = 'block';
        document.getElementById('rendimientoElectrico').required = true;
    } 
    else if (tipo === 'hibrido') {
        // H√≠brido necesita AMBOS
        camposGasolina.style.display = 'block';
        camposElectrico.style.display = 'block';
        document.getElementById('rendimientoGasolina').required = true;
        document.getElementById('rendimientoElectrico').required = true;
    }
});

// ===== CARGAR REPARTIDORES =====
async function cargarRepartidores() {
    try {
        const response = await fetch(`${API_URL}/auth/repartidores`);
        const data = await response.json();
        
        const select = document.getElementById('repartidorId');
        select.innerHTML = '<option value="">Seleccionar repartidor</option>';
        
        data.repartidores.forEach(rep => {
            const option = document.createElement('option');
            option.value = rep.id;
            option.textContent = `${rep.nombre_completo} (ID: ${rep.id})`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error al cargar repartidores:', error);
        mostrarNotificacion('Error al cargar repartidores', 'error');
    }
}

// ===== CARGAR VEH√ÉCULOS DISPONIBLES =====
async function cargarVehiculosDisponibles() {
    try {
        const response = await fetch(`${API_URL}/vehiculos/vehiculos?disponibles_solo=true`);
        const vehiculos = await response.json();
        
        const select = document.getElementById('vehiculoId');
        select.innerHTML = '<option value="">Seleccionar veh√≠culo</option>';
        
        vehiculos.forEach(v => {
            const option = document.createElement('option');
            option.value = v.id;
            option.textContent = `${v.modelo} (Cap: ${v.capacidad_maxima_paquetes})`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error al cargar veh√≠culos:', error);
        mostrarNotificacion('Error al cargar veh√≠culos disponibles', 'error');
    }
}

// ===== CARGAR TABLA DE VEH√ÉCULOS =====
async function cargarTablaVehiculos() {
    try {
        const response = await fetch(`${API_URL}/vehiculos/vehiculos`);
        const vehiculos = await response.json();
        
        const cuerpo = document.getElementById('cuerpoTabla');
        cuerpo.innerHTML = '';
        
        if (vehiculos.length === 0) {
            cuerpo.innerHTML = '<tr><td colspan="6" style="text-align: center;">No hay veh√≠culos registrados</td></tr>';
            return;
        }
        
        vehiculos.forEach(v => {
            const fila = document.createElement('tr');
            fila.innerHTML = `
                <td><strong>${v.id}</strong></td>
                <td>${v.modelo}</td>
                <td>${v.tipo}</td>
                <td>${v.capacidad_maxima_paquetes} paq.</td>
                <td>
                    <span class="status status-${v.estado}">
                        ${v.estado.toUpperCase()}
                    </span>
                </td>
                <td>${v.asignado_a || 'No asignado'}</td>
            `;
            cuerpo.appendChild(fila);
        });
    } catch (error) {
        console.error('Error al cargar tabla:', error);
        document.getElementById('cuerpoTabla').innerHTML = 
            '<tr><td colspan="6" style="text-align: center; color: red;">Error al cargar veh√≠culos</td></tr>';
    }
}

// ===== CARGAR ASIGNACIONES ACTIVAS =====
async function cargarAsignacionesActivas() {
    try {
        const response = await fetch(`${API_URL}/vehiculos/asignaciones?activas_solo=true`);
        const asignaciones = await response.json();
        
        const select = document.getElementById('asignacionActiva');
        select.innerHTML = '<option value="">Seleccionar</option>';
        
        asignaciones.forEach(asig => {
            const option = document.createElement('option');
            option.value = asig.id;
            option.textContent = `${asig.repartidor_nombre} ‚Üí ${asig.vehiculo_modelo}`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error al cargar asignaciones:', error);
    }
}

// ===== FORMULARIO: REGISTRAR VEH√ÉCULO (ACTUALIZADO) =====
document.getElementById('formVehiculo').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('btnGuardarVehiculo');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
    
    const tipo = document.getElementById('tipo').value;
    
    // Construir datos base
    const datos = {
        modelo: document.getElementById('modelo').value,
        tipo: tipo,
        capacidad_maxima_paquetes: parseInt(document.getElementById('capacidad').value),
        velocidad_promedio_kmh: parseFloat(document.getElementById('velocidad').value),
        hora_envio: document.getElementById('horaEnvio').value || null
    };
    
    // Agregar campos seg√∫n tipo de veh√≠culo
    if (tipo === 'gasolina') {
        datos.rendimiento_gasolina = parseFloat(document.getElementById('rendimientoGasolina').value);
        datos.precio_gasolina = parseFloat(document.getElementById('precioGasolina').value) || 22.50;
    } 
    else if (tipo === 'electrico') {
        datos.rendimiento_electrico = parseFloat(document.getElementById('rendimientoElectrico').value);
        datos.precio_kwh = parseFloat(document.getElementById('precioKwh').value) || 2.50;
    } 
    else if (tipo === 'hibrido') {
        // H√≠brido necesita AMBOS
        datos.rendimiento_gasolina = parseFloat(document.getElementById('rendimientoGasolina').value);
        datos.precio_gasolina = parseFloat(document.getElementById('precioGasolina').value) || 22.50;
        datos.rendimiento_electrico = parseFloat(document.getElementById('rendimientoElectrico').value);
        datos.precio_kwh = parseFloat(document.getElementById('precioKwh').value) || 2.50;
    }
    
    try {
        const response = await fetch(`${API_URL}/vehiculos/vehiculos`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(datos)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Error al guardar');
        }
        
        const resultado = await response.json();
        mostrarNotificacion(`‚úÖ Veh√≠culo ${datos.modelo} registrado exitosamente (ID: ${resultado.id})`);
        this.reset();
        
        // Ocultar campos din√°micos despu√©s del reset
        document.getElementById('camposGasolina').style.display = 'none';
        document.getElementById('camposElectrico').style.display = 'none';
        
        // Recargar listas
        cargarTablaVehiculos();
        cargarVehiculosDisponibles();
    } catch (error) {
        console.error('Error completo:', error);
        mostrarNotificacion(error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save"></i> Guardar Veh√≠culo';
    }
});

// ===== FORMULARIO: ASIGNAR VEH√ÉCULO =====
document.getElementById('formAsignacion').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('btnAsignar');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Asignando...';
    
    const datos = {
        id_repartidor: parseInt(document.getElementById('repartidorId').value),
        id_vehiculo: parseInt(document.getElementById('vehiculoId').value),
        numero_paquetes: parseInt(document.getElementById('numeroPaquetes').value),
        ruta_municipio: document.getElementById('rutaMunicipio').value || null
    };
    
    try {
        const response = await fetch(`${API_URL}/vehiculos/asignaciones`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(datos)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Error al asignar');
        }
        
        const result = await response.json();
        mostrarNotificacion(`‚úÖ Veh√≠culo asignado a ${result.repartidor_nombre}`);
        this.reset();
        cargarTablaVehiculos();
        cargarVehiculosDisponibles();
        cargarAsignacionesActivas();
    } catch (error) {
        mostrarNotificacion(error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-link"></i> Asignar Veh√≠culo';
    }
});

// ===== LIBERAR ASIGNACI√É"N =====
document.getElementById('btnLiberar').addEventListener('click', async function() {
    const asignacionId = parseInt(document.getElementById('asignacionActiva').value);
    
    if (!asignacionId) {
        mostrarNotificacion('Seleccione una asignaci√≥n', 'error');
        return;
    }
    
    if (!confirm('¬øLiberar este veh√≠culo?')) return;
    
    try {
        const response = await fetch(`${API_URL}/vehiculos/asignaciones/${asignacionId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Error al liberar');
        }
        
        mostrarNotificacion('‚úÖ Asignaci√≥n liberada exitosamente');
        cargarTablaVehiculos();
        cargarVehiculosDisponibles();
        cargarAsignacionesActivas();
    } catch (error) {
        mostrarNotificacion(error.message, 'error');
    }
});

// ===== INICIALIZACI√É"N =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöö Gesti√≥n de Flota inicializada');
    
    // Cargar datos iniciales
    cargarRepartidores();
    cargarVehiculosDisponibles();
    cargarTablaVehiculos();
    cargarAsignacionesActivas();
});
    
    </script>
</body>
</html>