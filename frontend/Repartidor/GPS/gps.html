<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS - Ruta de Entrega</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root {
            --azul-oscuro: #0a1128;
            --azul-medio: #1c2e4a;
            --azul-claro: #274c77;
            --verde: #2ecc71;
            --blanco: #ffffff;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--azul-oscuro) 0%, var(--azul-medio) 100%);
            color: var(--blanco);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .gps-header {
            background: linear-gradient(135deg, var(--azul-medio) 0%, var(--azul-claro) 100%);
            color: var(--blanco);
            padding: 15px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        
        .header-content { display: flex; align-items: center; gap: 15px; }
        .header-content i { font-size: 1.8rem; color: var(--verde); }
        .header-content h1 { font-size: 1.5rem; margin: 0; font-weight: 600; }
        
        .gps-btn {
            background: linear-gradient(135deg, var(--azul-claro) 0%, var(--verde) 100%);
            border: none;
            color: var(--blanco);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            text-decoration: none;
        }
        
        .gps-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3); }
        
        #map {
            flex: 1;
            width: 100%;
            min-height: 0;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 17, 40, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 5px solid var(--verde);
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 17, 40, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 30px;
            z-index: 2000;
        }
        
        .error-icon { font-size: 4rem; color: #ff6b6b; margin-bottom: 20px; }
        .error-message { max-width: 500px; margin-bottom: 25px; line-height: 1.5; }
        
        .retry-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff4757 100%);
            border: none;
            color: var(--blanco);
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .gps-footer {
            background: rgba(28, 46, 74, 0.9);
            padding: 10px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--azul-claro);
            font-size: 0.9rem;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--verde);
            animation: pulse 2s infinite;
            margin-right: 10px;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="gps-header">
        <div class="header-content">
            <i class="fas fa-map-marked-alt"></i>
            <div>
                <h1 id="headerTitle">Sistema de Navegaci√≥n GPS</h1>
                <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;" id="headerSubtitle">Cargando ruta...</p>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button class="gps-btn" id="refreshMap" style="display: none;">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
            <a href="Ruta_repartidor.html" class="gps-btn">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div class="gps-footer">
        <div style="display: flex; align-items: center;">
            <div class="status-dot"></div>
            <span>GPS Activo</span>
        </div>
        <div><i class="fas fa-clock"></i> <span id="lastUpdated">--:--</span></div>
        <div id="currentLocation">Cargando ubicaci√≥n...</div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <h3>Cargando mapa de ruta...</h3>
        <p style="opacity: 0.7;">Procesando geometr√≠a de la ruta</p>
    </div>
    
    <div class="error-overlay" id="errorOverlay">
        <div class="error-icon"><i class="fas fa-exclamation-triangle"></i></div>
        <h2>Error al Cargar el Mapa</h2>
        <div class="error-message" id="errorMessage">No se encontr√≥ informaci√≥n de ruta.</div>
        <button class="retry-btn" onclick="location.href='Ruta_repartidor.html'">
            <i class="fas fa-arrow-left"></i> Volver al Panel
        </button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map = null;
        let rutaActual = null;

        // Actualizar tiempo
        function actualizarTiempo() {
            const ahora = new Date();
            const hora = ahora.getHours().toString().padStart(2, '0');
            const minuto = ahora.getMinutes().toString().padStart(2, '0');
            document.getElementById('lastUpdated').textContent = `${hora}:${minuto}`;
        }

        // Mostrar error
        function mostrarError(mensaje) {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('errorMessage').innerHTML = mensaje;
            document.getElementById('errorOverlay').style.display = 'flex';
        }

        // Cargar y renderizar mapa
        async function cargarMapa() {
            try {
                // 1. Obtener ruta desde localStorage
                const rutaGuardada = localStorage.getItem('rutaRepartidor');
                
                console.log('üîç DEBUG: localStorage contiene:', rutaGuardada ? 'S√ç' : 'NO');
                
                if (!rutaGuardada) {
                    mostrarError('No se encontr√≥ informaci√≥n de ruta.<br>Por favor, consulta tu ruta primero.');
                    return;
                }
                
                rutaActual = JSON.parse(rutaGuardada);
                console.log('‚úÖ Ruta recuperada:', rutaActual);
                
                // 2. Validar estructura completa
                if (!rutaActual.tiene_ruta) {
                    mostrarError('La asignaci√≥n existe pero no tiene ruta calculada.<br>El admin debe calcular la ruta primero.');
                    return;
                }
                
                if (!rutaActual.ruta) {
                    mostrarError('Objeto "ruta" no encontrado en los datos.');
                    return;
                }
                
                if (!rutaActual.ruta.geometria) {
                    mostrarError('Campo "geometria" no encontrado.');
                    return;
                }
                
                // 3. PROCESAMIENTO ROBUSTO DE GEOMETR√çA (SOLUCI√ìN ERROR NaN)
                const geometria = rutaActual.ruta.geometria;
                let coordenadas = [];
                
                console.log(`üìç Procesando ${geometria.length} puntos de geometr√≠a`);
                console.log('üîç Muestra del formato (primer elemento):', geometria[0]);

                if (geometria.length > 0) {
                    // CASO A: Formato lista de pares [[lat, lng], [lat, lng]]
                    if (Array.isArray(geometria[0])) {
                        console.log('Detected: Formato Array de Arrays');
                        coordenadas = geometria;
                    }
                    // CASO B: Formato lista plana [lat, lng, lat, lng]
                    else if (typeof geometria[0] === 'number') {
                        console.log('Detected: Formato Array Plano');
                        for (let i = 0; i < geometria.length; i += 2) {
                            coordenadas.push([geometria[i], geometria[i + 1]]);
                        }
                    }
                    // CASO C: Formato objeto [{lat:..., lng:...}]
                    else if (typeof geometria[0] === 'object' && 'lat' in geometria[0]) {
                        console.log('Detected: Formato Objeto LatLng');
                        coordenadas = geometria.map(p => [p.lat, p.lng]);
                    }
                }

                // Verificaci√≥n final de coordenadas
                if (coordenadas.length === 0) {
                    mostrarError('La geometr√≠a est√° vac√≠a o el formato no es reconocido.');
                    return;
                }
                
                console.log(`‚úÖ ${coordenadas.length} coordenadas procesadas exitosamente`);
                
                // 4. Calcular centro del mapa
                const latitudes = coordenadas.map(c => c[0]);
                const longitudes = coordenadas.map(c => c[1]);
                const centroLat = (Math.min(...latitudes) + Math.max(...latitudes)) / 2;
                const centroLng = (Math.min(...longitudes) + Math.max(...longitudes)) / 2;
                
                // 5. Crear mapa Leaflet
                map = L.map('map').setView([centroLat, centroLng], 12);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);
                
                // 6. Dibujar ruta
                const polyline = L.polyline(coordenadas, {
                    color: '#2ecc71',
                    weight: 5,
                    opacity: 0.8
                }).addTo(map);
                
                // 7. Marcador de inicio (verde)
                L.marker(coordenadas[0], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map).bindPopup(`
                    <strong>üìç Origen</strong><br>
                    ${rutaActual.ruta.origen}
                `);
                
                // 8. Marcador de destino (rojo)
                L.marker(coordenadas[coordenadas.length - 1], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map).bindPopup(`
                    <strong>üèÅ Destino</strong><br>
                    ${rutaActual.ruta.destino}<br><br>
                    <strong>üìè Distancia:</strong> ${rutaActual.ruta.distancia_km} km<br>
                    <strong>‚è±Ô∏è Tiempo:</strong> ${Math.round(rutaActual.ruta.tiempo_min)} min<br>
                    <strong>üì¶ Paquetes:</strong> ${rutaActual.asignacion.numero_paquetes}
                `).openPopup();
                
                // 9. Ajustar vista al recorrido
                map.fitBounds(polyline.getBounds(), { padding: [50, 50] });
                
                // 10. Actualizar header
                document.getElementById('headerTitle').textContent = `Ruta de ${rutaActual.repartidor.nombre}`;
                document.getElementById('headerSubtitle').textContent = `${rutaActual.ruta.distancia_km} km ‚Ä¢ ${Math.round(rutaActual.ruta.tiempo_min)} min ‚Ä¢ ${rutaActual.asignacion.numero_paquetes} paquetes`;
                document.getElementById('currentLocation').textContent = `üìç ${rutaActual.ruta.origen.substring(0, 30)}...`;
                
                // 11. Ocultar loading
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('refreshMap').style.display = 'flex';
                
                console.log('‚úÖ Mapa cargado exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error al cargar mapa:', error);
                mostrarError(`Error al procesar la ruta: ${error.message}`);
            }
        }

        // Inicializaci√≥n
        actualizarTiempo();
        setInterval(actualizarTiempo, 60000);
        
        // Cargar mapa al iniciar
        cargarMapa();
        
        // Bot√≥n actualizar
        document.getElementById('refreshMap').addEventListener('click', function() {
            if (map) {
                map.remove();
                map = null;
            }
            document.getElementById('loadingOverlay').style.display = 'flex';
            setTimeout(cargarMapa, 500);
        });
    </script>
</body>
</html>