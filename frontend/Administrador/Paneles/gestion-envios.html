<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Pedidos - RutaTec</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0c1b33 0%, #1a3a5f 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
        }

        /* A√ëADIDO: Bot√≥n de regresar */
        .btn-regresar {
            position: absolute;
            top: 25px;
            right: 25px;
            padding: 12px 25px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            z-index: 100;
        }

        .btn-regresar:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.4);
            background: linear-gradient(135deg, #2980b9, #3498db);
        }

        .header {
            background: rgba(26, 58, 95, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #3498db;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            padding-right: 180px; /* Espacio para el bot√≥n */
        }

        .header h1 {
            color: #ffffff;
            font-size: 2rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1::before {
            content: "üì¶";
            font-size: 2rem;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .card {
            background: rgba(26, 58, 95, 0.95);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #3498db;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .card h2 {
            color: #3498db;
            margin-bottom: 25px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #bbdefb;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(17, 17, 17, 0.9);
            border: 2px solid rgba(52, 152, 219, 0.4);
            border-radius: 10px;
            color: #ffffff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.2);
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .lista-pedidos {
            max-height: 500px;
            overflow-y: auto;
        }

        .pedido-item {
            background: rgba(17, 17, 17, 0.7);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }

        .pedido-item:hover {
            transform: translateX(5px);
            border-left-color: #2ecc71;
        }

        .pedido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .pedido-numero {
            color: #3498db;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .pedido-estado {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .estado-pendiente { background: #f39c12; color: #fff; }
        .estado-procesando { background: #3498db; color: #fff; }
        .estado-en_ruta { background: #9b59b6; color: #fff; }
        .estado-entregado { background: #2ecc71; color: #fff; }
        .estado-cancelado { background: #e74c3c; color: #fff; }

        .pedido-info {
            color: #bbdefb;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .pedido-info strong {
            color: #ffffff;
        }

        .mensaje {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .mensaje.exito {
            background: rgba(46, 204, 113, 0.2);
            border: 2px solid #2ecc71;
            color: #2ecc71;
            display: block;
        }

        .mensaje.error {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            color: #ff6b6b;
            display: block;
        }

        .estadisticas {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(17, 17, 17, 0.7);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid rgba(52, 152, 219, 0.3);
        }

        .stat-numero {
            font-size: 2rem;
            color: #3498db;
            font-weight: 700;
        }

        .stat-label {
            color: #bbdefb;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
            .estadisticas {
                grid-template-columns: 1fr;
            }
            .header {
                padding-right: 25px;
            }
            .btn-regresar {
                position: relative;
                top: 0;
                right: 0;
                width: 100%;
                margin-top: 15px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- A√ëADIDO: Bot√≥n de regresar - CAMBIA LA URL POR LA QUE NECESITES -->
        <a href="../PanelADM.html" class="btn-regresar">
            ‚Üê Regresar al Panel
        </a>

        <div class="header">
            <h1>Gesti√≥n de Pedidos</h1>
        </div>

        <div class="content">
            <!-- FORMULARIO -->
            <div class="card">
                <h2>üìù Crear Nuevo Pedido</h2>
                
                <div id="mensaje" class="mensaje"></div>

                <form id="formPedido">
                    <div class="form-group">
                        <label for="numeroPedido">N√∫mero de Pedido *</label>
                        <input type="text" id="numeroPedido" required placeholder="Ej: PED-2025-001">
                    </div>

                    <div class="form-group">
                        <label for="idRepartidor">ID Repartidor *</label>
                        <input type="number" id="idRepartidor" required placeholder="Ej: 2">
                    </div>

                    <div class="form-group">
                        <label for="idVehiculo">ID Veh√≠culo *</label>
                        <input type="number" id="idVehiculo" required placeholder="Ej: 1">
                    </div>

                    <div class="form-group">
                        <label for="destino">Destino de Entrega *</label>
                        <select id="destino" required>
                            <option value="">Seleccione un destino...</option>
                            <option value="destino1">UES Acambay</option>
                            <option value="destino2">UES El Oro</option>
                            <option value="destino3">UES Temascalciongo</option>
                            <option value="destino4">UES Jilotepec</option>
                            <option value="destino5">UES Morelos</option>
                            <option value="destino6">UES Ixtlahuaca</option>
                            <option value="destino7">UES San Jos√© del Rincon</option>
                            <option value="destino8">UES Jipilco</option>
                            <option value="destino9">UES Villa Victoria</option>
                            <option value="destino10">UES Atenco</option>
                            <option value="destino11">UES Chalco</option>
                            <option value="destino12">UES Ixtapaluca</option>
                            <option value="destino13">UES La Paz</option>
                            <option value="destino14">UES Huixquilucan</option>
                            <option value="destino15">UES Lerma</option>
                            <option value="destino16">UES Temoaya</option>
                            <option value="destino17">UES Tenango del Valle</option>
                            <option value="destino18">UES Xalatlalco</option>
                            <option value="destino19">UES Ecatepec</option>
                            <option value="destino20">UES Tec√°mac</option>
                            <option value="destino21">UES Tepotzotl√°n</option>
                            <option value="destino22">UES Tultitl√°n</option>
                            <option value="destino23">UES Tultepec</option>
                            <option value="destino24">UES Villa</option>
                            <option value="destino25">UES Almolaya de Alquisiras</option>
                            <option value="destino26">UES Coatepec Harinas</option>
                            <option value="destino27">UES Sultepec</option>
                            <option value="destino28">UES Tejupilco</option>
                            <option value="destino29">UES Tlatlaya</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="capacidad">Capacidad de Paquetes *</label>
                        <input type="number" id="capacidad" required min="1" placeholder="Ej: 15">
                    </div>

                    <div class="form-group">
                        <label for="estado">Estado *</label>
                        <select id="estado" required>
                            <option value="">Seleccione estado...</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="procesando">Procesando</option>
                            <option value="en_ruta">En Ruta</option>
                            <option value="entregado">Entregado</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>

                    <button type="submit" class="btn" id="btnGuardar">
                        üíæ Guardar Pedido
                    </button>
                </form>
            </div>

            <!-- LISTA DE PEDIDOS -->
            <div class="card">
                <h2>üìã Lista de Pedidos</h2>

                <div class="estadisticas">
                    <div class="stat-card">
                        <div class="stat-numero" id="totalPedidos">0</div>
                        <div class="stat-label">Total Pedidos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-numero" id="enRuta">0</div>
                        <div class="stat-label">En Ruta</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-numero" id="entregados">0</div>
                        <div class="stat-label">Entregados</div>
                    </div>
                </div>

                <div class="lista-pedidos" id="listaPedidos">
                    <p style="color: #bbdefb; text-align: center; padding: 30px;">
                        No hay pedidos registrados. Crea el primero.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
    
    // ===== CONFIGURACI√ìN =====
    const API_URL = 'http://localhost:8000/api';
    
    // ===== ELEMENTOS DEL DOM =====
    const form = document.getElementById('formPedido');
    const mensaje = document.getElementById('mensaje');
    const listaPedidos = document.getElementById('listaPedidos');
    const btnGuardar = document.getElementById('btnGuardar');
    const numeroPedidoInput = document.getElementById('numeroPedido');
    const idRepartidorInput = document.getElementById('idRepartidor');
    const idVehiculoInput = document.getElementById('idVehiculo');
    const destinoSelect = document.getElementById('destino');
    const capacidadInput = document.getElementById('capacidad');
    const estadoSelect = document.getElementById('estado');

    // ===== VARIABLE GLOBAL PARA CONTROLAR PEDIDOS =====
    let pedidosCargados = new Set(); // Para evitar duplicados

    // ===== FUNCIONES DE UTILIDAD =====
    function mostrarMensaje(texto, tipo) {
        mensaje.textContent = texto;
        mensaje.className = `mensaje ${tipo}`;
        mensaje.style.display = 'block';
        
        setTimeout(() => {
            mensaje.style.display = 'none';
        }, 4000);
    }

    function actualizarEstadisticas(estadisticas) {
        document.getElementById('totalPedidos').textContent = estadisticas.total_pedidos;
        document.getElementById('enRuta').textContent = estadisticas.pedidos_en_ruta;
        document.getElementById('entregados').textContent = estadisticas.pedidos_entregados;
    }

    async function cargarRepartidores() {
        try {
            const response = await fetch(`${API_URL}/pedidos/repartidores`);
            const data = await response.json();
            
            if (data.repartidores && data.repartidores.length > 0) {
                console.log('‚úÖ Repartidores cargados:', data.repartidores);
            }
        } catch (error) {
            console.error('‚ùå Error cargando repartidores:', error);
        }
    }

    async function cargarVehiculos() {
        try {
            const response = await fetch(`${API_URL}/pedidos/vehiculos`);
            const data = await response.json();
            
            if (data.vehiculos && data.vehiculos.length > 0) {
                console.log('‚úÖ Veh√≠culos cargados:', data.vehiculos);
            }
        } catch (error) {
            console.error('‚ùå Error cargando veh√≠culos:', error);
        }
    }

    async function cargarEstadisticas() {
        try {
            const response = await fetch(`${API_URL}/pedidos/estadisticas`);
            const data = await response.json();
            actualizarEstadisticas(data);
        } catch (error) {
            console.error('Error cargando estad√≠sticas:', error);
        }
    }

    async function crearPedidoAPI(datos) {
        const token = localStorage.getItem('token');
        
        const response = await fetch(`${API_URL}/pedidos/crear`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            },
            body: JSON.stringify(datos)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Error al crear pedido');
        }
        
        return await response.json();
    }

    async function listarPedidosAPI() {
        try {
            const response = await fetch(`${API_URL}/pedidos/`);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.detail || 'Error al cargar pedidos');
            }
            
            return data;
        } catch (error) {
            console.error('Error listando pedidos:', error);
            return [];
        }
    }

    function renderizarPedidos(pedidos) {
        if (!pedidos || pedidos.length === 0) {
            listaPedidos.innerHTML = `
                <p style="color: #bbdefb; text-align: center; padding: 30px;">
                    No hay pedidos registrados. Crea el primero.
                </p>
            `;
            pedidosCargados.clear();
            return;
        }

        // Filtrar pedidos duplicados usando un Set
        const pedidosUnicos = [];
        const numerosPedidosVistos = new Set();
        
        for (const pedido of pedidos) {
            if (!numerosPedidosVistos.has(pedido.id)) {
                numerosPedidosVistos.add(pedido.id);
                pedidosUnicos.push(pedido);
            }
        }

        // Actualizar el Set global
        pedidosCargados = numerosPedidosVistos;

        // Ordenar por fecha m√°s reciente primero
        pedidosUnicos.sort((a, b) => new Date(b.fecha_creacion) - new Date(a.fecha_creacion));

        listaPedidos.innerHTML = pedidosUnicos.map(pedido => `
            <div class="pedido-item">
                <div class="pedido-header">
                    <span class="pedido-numero">${pedido.numero_pedido}</span>
                    <span class="pedido-estado estado-${pedido.estado}">
                        ${pedido.estado.toUpperCase()}
                    </span>
                </div>
                <div class="pedido-info">
                    <strong>Repartidor:</strong> ${pedido.nombre_repartidor} (ID: ${pedido.id_repartidor})<br>
                    <strong>Veh√≠culo:</strong> ${pedido.modelo_vehiculo} (${pedido.tipo_vehiculo})<br>
                    <strong>Destino:</strong> ${pedido.destino_entrega}<br>
                    <strong>Paquetes:</strong> ${pedido.capacidad_paquetes}<br>
                    <strong>Creado:</strong> ${new Date(pedido.fecha_creacion).toLocaleDateString()}
                </div>
                <div style="margin-top: 10px; font-size: 0.8rem; color: #888;">
                    ID: ${pedido.id}
                </div>
            </div>
        `).join('');
    }

    async function cargarYRenderizarPedidos() {
        try {
            const pedidos = await listarPedidosAPI();
            renderizarPedidos(pedidos);
            await cargarEstadisticas();
        } catch (error) {
            console.error('Error cargando pedidos:', error);
        }
    }

    // ===== MEJORAS: Funci√≥n para generar n√∫mero de pedido autom√°tico =====
    function generarNumeroPedido() {
        const fecha = new Date();
        const a√±o = fecha.getFullYear();
        const mes = String(fecha.getMonth() + 1).padStart(2, '0');
        const dia = String(fecha.getDate()).padStart(2, '0');
        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        return `PED-${a√±o}${mes}${dia}-${random}`;
    }

    // ===== MEJORAS: Limpiar formulario (no reset completo) =====
    function limpiarFormulario() {
        // Generar nuevo n√∫mero de pedido autom√°tico
        numeroPedidoInput.value = generarNumeroPedido();
        
        // Limpiar otros campos pero mantenerlos listos para usar
        idRepartidorInput.value = '';
        idVehiculoInput.value = '';
        destinoSelect.selectedIndex = 0;
        capacidadInput.value = '15'; // Valor por defecto √∫til
        estadoSelect.selectedIndex = 0;
        
        // Enfocar el primer campo despu√©s del n√∫mero de pedido
        idRepartidorInput.focus();
    }

    // ===== MEJORAS: Verificar si pedido ya existe =====
    async function verificarPedidoExistente(numeroPedido) {
        try {
            const response = await fetch(`${API_URL}/pedidos/verificar/${numeroPedido}`);
            const data = await response.json();
            return data.existe || false;
        } catch (error) {
            console.error('Error verificando pedido:', error);
            return false;
        }
    }

    // ===== EVENTOS =====
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const datos = {
            numero_pedido: numeroPedidoInput.value.trim(),
            id_repartidor: parseInt(idRepartidorInput.value),
            id_vehiculo: parseInt(idVehiculoInput.value),
            destino_entrega: destinoSelect.value,
            capacidad_paquetes: parseInt(capacidadInput.value),
            estado: estadoSelect.value
        };

        // Validaciones mejoradas
        if (!datos.numero_pedido || !datos.id_repartidor || !datos.id_vehiculo || 
            !datos.destino_entrega || !datos.capacidad_paquetes || !datos.estado) {
            mostrarMensaje('Por favor completa todos los campos', 'error');
            return;
        }

        if (datos.capacidad_paquetes < 1) {
            mostrarMensaje('La capacidad debe ser al menos 1 paquete', 'error');
            return;
        }

        if (datos.id_repartidor <= 0) {
            mostrarMensaje('El ID del repartidor debe ser v√°lido', 'error');
            return;
        }

        if (datos.id_vehiculo <= 0) {
            mostrarMensaje('El ID del veh√≠culo debe ser v√°lido', 'error');
            return;
        }

        // Verificar si el pedido ya existe en la lista actual
        if (pedidosCargados.has(datos.numero_pedido)) {
            mostrarMensaje('‚ö†Ô∏è Este n√∫mero de pedido ya est√° registrado', 'error');
            return;
        }

        btnGuardar.disabled = true;
        btnGuardar.textContent = '‚è≥ Guardando...';

        try {
            console.log('üì§ Enviando datos:', datos);
            
            const resultado = await crearPedidoAPI(datos);
            
            mostrarMensaje(`‚úÖ Pedido ${resultado.numero_pedido} creado exitosamente`, 'exito');
            
            // Limpiar formulario (sin reset completo)
            limpiarFormulario();
            
            // Recargar lista de pedidos desde el servidor
            await cargarYRenderizarPedidos();
            
            console.log('‚úÖ Pedido creado:', resultado);
            
        } catch (error) {
            mostrarMensaje(`‚ùå Error: ${error.message}`, 'error');
            console.error('Error creando pedido:', error);
        } finally {
            btnGuardar.disabled = false;
            btnGuardar.textContent = 'üíæ Guardar Pedido';
        }
    });

    // ===== MEJORAS: Cargar opciones de repartidores y veh√≠culos =====
    async function cargarOpcionesRepartidores() {
        try {
            const response = await fetch(`${API_URL}/pedidos/repartidores`);
            const data = await response.json();
            
            if (data.repartidores && data.repartidores.length > 0) {
                console.log('Repartidores disponibles:', data.repartidores);
                // Opcional: crear datalist para autocompletar
            }
        } catch (error) {
            console.error('Error cargando repartidores:', error);
        }
    }

    async function cargarOpcionesVehiculos() {
        try {
            const response = await fetch(`${API_URL}/pedidos/vehiculos`);
            const data = await response.json();
            
            if (data.vehiculos && data.vehiculos.length > 0) {
                console.log('Veh√≠culos disponibles:', data.vehiculos);
                // Opcional: crear datalist para autocompletar
            }
        } catch (error) {
            console.error('Error cargando veh√≠culos:', error);
        }
    }

    // ===== MEJORAS: Cargar pedidos peri√≥dicamente para mantener actualizado =====
    let intervaloActualizacion = null;

    function iniciarActualizacionAutomatica() {
        // Cargar pedidos cada 30 segundos
        intervaloActualizacion = setInterval(async () => {
            console.log('üîÑ Actualizando lista de pedidos autom√°ticamente...');
            await cargarYRenderizarPedidos();
        }, 30000); // 30 segundos
    }

    function detenerActualizacionAutomatica() {
        if (intervaloActualizacion) {
            clearInterval(intervaloActualizacion);
            intervaloActualizacion = null;
        }
    }

    // ===== INICIALIZACI√ìN =====
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('üöÄ Sistema de gesti√≥n de pedidos iniciado');
        
        // Generar n√∫mero de pedido autom√°ticamente al inicio
        numeroPedidoInput.value = generarNumeroPedido();
        
        // Cargar datos iniciales
        await cargarRepartidores();
        await cargarVehiculos();
        await cargarYRenderizarPedidos();
        
        // Cargar opciones para selects
        await cargarOpcionesRepartidores();
        await cargarOpcionesVehiculos();
        
        // Iniciar actualizaci√≥n autom√°tica
        iniciarActualizacionAutomatica();
        
        // Detener actualizaci√≥n cuando la pesta√±a no est√° activa
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                detenerActualizacionAutomatica();
            } else {
                iniciarActualizacionAutomatica();
                // Recargar datos al volver a la pesta√±a
                cargarYRenderizarPedidos();
            }
        });

        // Mostrar datos de ejemplo en consola
        console.log('üìã Usa estos datos de ejemplo:');
        console.log('- Repartidor ID: 2 (Juan P√©rez)');
        console.log('- Veh√≠culo ID: 1 (Toyota Hilux)');
        console.log('- N√∫mero pedido ya generado autom√°ticamente');
        console.log('- Destino: destino1 (cualquiera de la lista)');
        console.log('- Capacidad: 15');
        console.log('- Estado: pendiente');
    });
// v4 
    </script>
</body>
</html>